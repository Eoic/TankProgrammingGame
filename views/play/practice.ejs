<html>

<head>
    <title> Practice </title>
    <% include ../partials/codemirror %>
    <% include ../partials/styles %>
</head>

<body class="full-height overflow-hide">
    <% include ../partials/navbar %>

    <div id="notification no-display" class="bg-primary"> </div>

    <div style="height: calc(100% - 63px);">

            <!-- Game view [First half]-->
            <div id="game-view" class="split split-vertical" onwheel="zoomOnWheel(event)">

                <!-- Hamburger for list menu -->
                <span class="navbar-toggler bars" id="sidebarOpenButton" style="font-size: 30px; cursor: pointer; position: fixed; width: 250px"
                    onclick="toggleSidebar()">
                    <i class="fa fa-bars"></i>
                </span>

                <!-- List of robots -->
                <div class="bg-dark full-height sidebar-list" id="sidebar">

                    <button class="btn btn-outline-danger btn-lg rounded-0 full-width" onclick="closeSidebar()">
                        <i class="fa fa-times fa-lg"></i> CLOSE
                    </button>
                    <% for(var i = 0; i < print.length; i++) {%>
                        <button class="btn btn-primary btn-lg rounded-0 full-width" onclick="chooseRobot(this)">
                            <%= print[i].name %>
                        </button>
                    <% } %>
                </div>

                <!-- Game canvas -->
                <div id="display"></div>
            </div>

            <!-- Splitter -->
            <div class="gutter gutter-vertical"></div>

            <!-- Code editor [Second half]-->
            <div id="code-view" class="split split-vertical">

                <!-- Control butons -->
                <div class="full-width bg-secondary" style="position: sticky; top: 0; overflow: hidden; z-index: 105;">
                    <button class="btn btn-success btn-lg rounded-0" onclick="execute()" title="RUN">
                        <i class="fa fa-play"></i>
                    </button>

                    <button id="save" class="btn btn-primary btn-lg rounded-0" data-toggle="modal" data-target="#saveCodeModal" title="SAVE CODE">
                        <i class="fa fa-save"></i>
                    </button>

                    <button class="btn btn-danger btn-lg rounded-0" onclick="stopGame()" title="STOP">
                        <i class="fa fa-stop"></i>
                    </button>

                    <button class="btn btn-info btn-lg rounded-0" onclick="openConsole()" title="LOGS">
                        <i class="fa fa-info"></i>
                    </button>
                </div>

                <div id="editor"> </div>
                <script src="./js/code_editor.js"></script>
            </div>
        </div>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.2.0/split.min.js"></script>
        <script src="./js/splitter.js"></script>
        <script src="./js/game/pixi.min.js"></script>
        <script src="./js/game/game-main.js"></script>

        <script>

            // Setting initial values.
            editor.setValue(`<%- print[0].code %>`)
            var robotNameInternal = `<%= print[0].name %>`

            // Choose robot on button click.
            function chooseRobot(element){
                `<% for(var i = 0; i < print.length; i++){ %>`
                    if(element.innerText === `<%= print[i].name %>`){
                        editor.setValue(`<%- print[i].code %>`);
                        robotNameInternal = `<%= print[i].name %>`;
                    }
                `<% } %>`
            }

            // Save code for selected robot.
            function saveCode() {
                $.ajax({
                    type: "POST",
                    data: { robotName: robotNameInternal, code: editor.getValue() },
                    url: '/update-robot-code',
                    success: sendNotification('Code changes has been saved for ' + robotNameInternal + '.'),
                    error: err => { sendNotification('An error occoured.'); }
                });

                $('#saveCodeModal').modal('hide');
            }

            function sendNotification(message) {
                $("#notification").fadeIn("slow").text(message);
                dismissNotification();
            }

            function dismissNotification() {
                $("#notification").delay(3000).fadeOut("slow");
            }

            // REPETITIVE. Make toggler script to handle sidebar states.
            function toggleSidebar() {
                if (document.getElementById("sidebar").style.width == "0px")
                    openSidebar();
                else closeSidebar();
            }

            switch (localStorage.getItem("robotListSidebar")) {
                case 'open':
                    openSidebar();
                    break;
                case 'closed' || null:
                    closeSidebar();
                    break;
            }

            function openSidebar() {
                document.getElementById('sidebarOpenButton').style.display = "none";
                document.getElementById('sidebar').style.display = "block";
                document.getElementById("sidebar").style.width = "250px";
                document.getElementById("display").style.marginLeft = "250px";
                localStorage.setItem("robotListSidebar", "open");
            }

            function closeSidebar() {
                document.getElementById('sidebarOpenButton').style.display = "block";
                document.getElementById('sidebar').style.display = "none";
                document.getElementById("sidebar").style.width = "0";
                document.getElementById("display").style.marginLeft = "0";
                localStorage.setItem("robotListSidebar", "closed");
            }

        </script>

        <!-- Game logic -->
        <script>

            // Execute game loop.
            function execute() {
                sendNotification('Simulation started...');

                if (!app.ticker.started)
                    app.ticker.start();

                function gameLoop(delta) {
                    eval(editor.getValue());
                }

                app.ticker.add(delta => gameLoop(delta));
            }

            // Stop game loop.
            function stopGame() {
                sendNotification('Simulation has been stopped.')
                app.ticker.stop();
            }

        </script>

        <!-- Robot code sav modal. -->
        <div class="modal fade" id="saveCodeModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content rounded-0">
                    <div class="modal-header">
                        <h5 class="modal-title" id="saveModalLabel"> Save code? </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary rounded-0" data-dismiss="modal"> Close </button>
                        <button type="button" class="btn btn-primary rounded-0" onclick="saveCode()"> Save changes </button>
                    </div>
                </div>
            </div>
        </div>

        <% include ../partials/bootstrapjs %>

        <!-- Inserts name of selected robot to modal. -->
        <script>
            $('#saveCodeModal').on('show.bs.modal', function(e) {
                var $modal = $(this);
                $modal.find('.modal-body').html(robotNameInternal);
            });
        </script>

    </body>
</html>